<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-core-activity/at-core-activity.html" />
<link rel="import" href="../at-carbon-tree/at-carbon-tree.html" />
<link rel="import" href="../at-carbon-message/at-carbon-message.html" />

<dom-module id="at-carbon-sitemap">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

      :host * {
        display: block;
        box-sizing: border-box;
      }

    </style>
    
    <at-core-activity url="[[url]]" indicator auto handle-as="json" on-response="_handleCoreActivityResponse"></at-core-activity>
    <at-carbon-message id="carbonMessage" type="info" hidden></at-carbon-message>
    <at-carbon-tree id="carbonTree"></at-carbon-tree>

  </template>
</dom-module>
<script>
  Polymer({
    is: "at-carbon-sitemap",
    properties: {
      
      url: {
        type: String,
        value: ''
      }
    },

    detached: function() {
      this.$.carbonTree.removeEventListener('value-changed', this._boundCarbonTreeValueChangedEventHanlder);
    },

    ready: function () {
    },

    _handleCoreActivityResponse: function(event) {
      var receivedData = event.detail.Data.items;

      if (!receivedData || !receivedData.length) {
        this.$.carbonMessage.html = "No data available";
        Polymer.dom(this.$.carbonMessage).removeAttribute('hidden');
        return;
      }

      this.$.carbonTree.data = receivedData;

      // flush the dom to avoid rendering issues
      Polymer.dom.flush();

      // in data received find the id of the node whose link ends with current url in browser, and use the id of the node to select it
      var currentUrl = window.location.href;
    
      var result = this._findSelectedNodeData(receivedData, currentUrl);
      var value = result ? result.id : null;
      this.$.carbonTree.value = value;

      if (!this._boundCarbonTreeValueChangedEventHanlder) {
        this._boundCarbonTreeValueChangedEventHanlder = this._handleCarbonTreeValueChanged.bind(this)
      }

      this.$.carbonTree.addEventListener('value-changed', this._boundCarbonTreeValueChangedEventHanlder);
    },

    _findSelectedNodeData: function(nodes, currentUrl) {

      if (!nodes || !nodes.length) return;
      if (!currentUrl) return;

      for (var i = 0; i < nodes.length; i++) {
        var nodeData = nodes[i];

        if (nodeData.link) {
          var endsWithRegexp = new RegExp(nodeData.link + "$");
          if (endsWithRegexp.test(currentUrl)) {
            return nodeData;
          }
        }

        if (!nodeData.children || !nodeData.children.length) continue;
        
        var result = this._findSelectedNodeData(nodeData.children, currentUrl);
        if (result) return result;
      }
    },

    _handleCarbonTreeValueChanged: function(event) {
      var nodeId = event.detail.value;
      var data = this.$.carbonTree.data;

      var node = this._findNodeById(nodeId, data);
      if (!node || !node.link) return;

      var currentUrl = window.location.href;
      var currentUrlNode = this._findSelectedNodeData(data, currentUrl);
      if (currentUrlNode) { 
        // update the href by replacing the currenUrlNode.link with node.link
        var replaceWithRegExp = new RegExp(currentUrlNode.link + "$");
        currentUrl = currentUrl.replace(replaceWithRegExp, node.link);
        window.location.href = currentUrl;

      } else {
        // update the href by setting window.location.href to node.link
        window.location.href = node.link;
      }
    },

    _findNodeById: function(nodeId, data) {

      if (!nodeId) return;
      if (!data || !data.length) return;

      for (var i = 0; i < data.length; i++) {
        var nodeData = data[i];

        if (nodeData.id == nodeId) {
          return nodeData;
        }

        if (!nodeData.children || !nodeData.children.length) continue;
        
        var result = this._findNodeById(nodeId, nodeData.children);
        if (result) return result;
      }
    }

  });
</script>
